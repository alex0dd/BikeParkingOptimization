<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
            integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
            crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
            integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
            crossorigin=""></script>
        <script src="./js/CoordinateProvider.js"></script>
        <script src="./js/LocationMap.js"></script>
    </head>
    <style>
    #mapid { height: 720px; }
    .slidecontainer {
        width: 100%;
    }

    .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 25px;
        background: #d3d3d3;
        outline: none;
        opacity: 0.7;
        -webkit-transition: .2s;
        transition: opacity .2s;
        margin: 0;
    }
    </style>
    <body>
        <div id="mapid"></div>
        <div id="debug"></div>
        <div class="slidecontainer">
            <input id="timeSlider" class="slider" type="range" min="0" max="100" value="0">
        </div>
        <script>
            /*
            Visualization parameters
            */
            const RandomNumber = (minimum, maximum) => Math.floor(Math.random() * (maximum - minimum + 1)) + minimum;
            const bounds = {t: 60, x: 30, y: 30}; //We will use these bounds approx in the final application {t: 1440, x: 80, y: 80} 
            var initialLocation = [44.484443, 11.325102];//[44.49381, 11.33875]; // Bologna is latitude=44.49381, longitude=11.33875
            var squareLength = 100; // 100 meters
            var coordProvider = new CoordinateProvider(initialLocation, squareLength);
            var locationMap = new LocationMap(bounds);

            // Map renderer
            function renderMap(map, time, boundX, boundY, boundT, coordProvider, locationMap){
                var t = time < boundT ? time : boundT - 1;
                /*
                pseudocode:
                for i=0 to n row
                    for j=0 to n column
                        renderRect([i, j], [i+1, j+1])
                */
                for(var i = 0; i < boundY; i++){
                    for(var j = 0; j < boundX; j++){
                        var population = locationMap.getPopulationAt(t, i, j);
                        var colorWeight = (population/locationMap.getHighestPopulation(t))*0.9;
                        L.rectangle([coordProvider.elementAt(i, j), coordProvider.elementAt(i+1,j+1)],{
                            color: "#00000f", 
                            weight: 1.0, 
                            fillColor: "green", 
                            fillOpacity: colorWeight
                        }).bindPopup(locationMap.getPopulationAt(t, i, j)+"").addTo(map);
                    }
                }
            }

            /*
            Map related
            */
            L.Map.include({'clearShapeLayers': function () {
                    this.eachLayer(function (layer) {
                        // if it's a shape layer
                        if (!(layer instanceof L.TileLayer)) this.removeLayer(layer);
                    }, this);
                }
            });
            // preferCanvas makes all points render in a canvas, avoiding to create a DOM element for each point, making the rendering faster
            var map = L.map('mapid', {preferCanvas: true}).setView(initialLocation, 18);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18}).addTo(map);
            
            // Generate random population data
            for(var t = 0; t < bounds.t; t++)
                for(var i = 0; i < bounds.y; i++) 
                    for(var j = 0; j < bounds.x; j++) 
                        locationMap.setPopulationAt(t, i, j, RandomNumber(0, 100));
            /*
            Components
            */
            var debugDiv = document.getElementById('debug');
            var timeSlider = document.getElementById('timeSlider');
            timeSlider.value = 0;
            timeSlider.min = 0;
            timeSlider.max = bounds.t - 1;
            timeSlider.addEventListener('input', (e)=>{
                var newTimeValue = e.target.value;
                debugDiv.innerText = "Current time: "+newTimeValue;
                map.clearShapeLayers();
                renderMap(map, newTimeValue, bounds.x, bounds.y, bounds.t, coordProvider, locationMap);
            });

            debugDiv.innerText = "Current time: "+0;                        
            map.on('click', function(e) {
                debugDiv.innerText = "Clicked on: "+e.latlng.lat+", "+e.latlng.lng;
            });
            // Render initial map for t=0
            renderMap(map, 0, bounds.x, bounds.y, bounds.t, coordProvider, locationMap);
        </script>
    </body>
</html>